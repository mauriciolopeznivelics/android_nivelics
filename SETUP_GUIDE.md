# üöÄ Gu√≠a Completa de Configuraci√≥n SonarQube + GitHub Actions

Esta gu√≠a te llevar√° paso a paso para configurar el sistema completo de an√°lisis de calidad de c√≥digo que **bloquea autom√°ticamente merges** hasta que el c√≥digo pase por SonarQube.

## üìã Requisitos Previos

- ‚úÖ SonarQube ejecut√°ndose en: `http://localhost:9000`
- ‚úÖ Proyecto Android en GitHub
- ‚úÖ Permisos de administrador en el repositorio GitHub

## üîß PASO 1: Configurar SonarQube

### 1.1 Acceso Inicial

1. **Abrir SonarQube en el navegador:**
   ```
   http://localhost:9000
   ```

2. **Iniciar sesi√≥n:**
   - **Usuario:** `admin`
   - **Contrase√±a:** `admin`

3. **Cambiar contrase√±a por defecto:**
   - SonarQube te pedir√° cambiar la contrase√±a
   - Usa una contrase√±a segura y gu√°rdala

### 1.2 Generar Token de Acceso

1. **Ir a configuraci√≥n de usuario:**
   - Click en el avatar (esquina superior derecha)
   - Seleccionar **"My Account"**

2. **Generar token:**
   - Ir a la pesta√±a **"Security"**
   - En la secci√≥n **"Tokens"**
   - **Name:** `GitHub Actions Integration`
   - **Type:** `Global Analysis Token`
   - Click **"Generate"**

3. **Copiar el token:**
   ```
   squ_a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0
   ```
   ‚ö†Ô∏è **IMPORTANTE:** Guarda este token, no se mostrar√° de nuevo.

### 1.3 Configurar Quality Gates Autom√°ticamente

1. **Abrir terminal en el proyecto:**
   ```bash
   # Configurar variables de entorno
   export SONAR_HOST_URL='http://localhost:9000'
   export SONAR_TOKEN='squ_tu_token_copiado_aqui'
   
   # Ejecutar configuraci√≥n autom√°tica
   chmod +x scripts/configure-quality-gate.sh
   ./scripts/configure-quality-gate.sh
   ```

2. **Verificar que se cre√≥ el Quality Gate:**
   - En SonarQube: **Quality Gates** ‚Üí Debe aparecer **"Android Strict"**
   - Verificar que est√© marcado como **"Default"**

## üêô PASO 2: Configurar GitHub Repository

### 2.1 Configurar Secrets del Repositorio

1. **Ir a tu repositorio en GitHub:**
   ```
   https://github.com/tu-usuario/tu-repositorio
   ```

2. **Acceder a Settings:**
   - Click en **"Settings"** (pesta√±a del repositorio)
   - En el men√∫ lateral: **"Secrets and variables"** ‚Üí **"Actions"**

3. **Agregar SONAR_HOST_URL:**
   - Click **"New repository secret"**
   - **Name:** `SONAR_HOST_URL`
   - **Secret:** `http://192.168.34.214:9000`
   - Click **"Add secret"**

4. **Agregar SONAR_TOKEN:**
   - Click **"New repository secret"**
   - **Name:** `SONAR_TOKEN`
   - **Secret:** `squ_tu_token_copiado_aqui`
   - Click **"Add secret"**

### 2.2 Configurar Branch Protection Rules

#### Opci√≥n A: Configuraci√≥n Autom√°tica (Recomendada)

1. **Generar GitHub Personal Access Token:**
   - Ir a: https://github.com/settings/tokens
   - Click **"Generate new token (classic)"**
   - **Scopes necesarios:**
     - ‚úÖ `repo` (Full control of private repositories)
     - ‚úÖ `admin:repo_hook` (Admin access to repository hooks)
   - Click **"Generate token"**
   - Copiar el token: `ghp_xxxxxxxxxxxxxxxxxxxx`

2. **Ejecutar script de configuraci√≥n:**
   ```bash
   # Configurar variables
   export GITHUB_TOKEN="ghp_tu_token_github"
   export GITHUB_REPO="tu-usuario/tu-repositorio"
   
   # Ejecutar configuraci√≥n
   chmod +x scripts/setup-github-protection.sh
   ./scripts/setup-github-protection.sh
   ```

#### Opci√≥n B: Configuraci√≥n Manual

1. **Ir a Branch Protection:**
   - En tu repositorio: **Settings** ‚Üí **Branches**
   - Click **"Add rule"** o editar regla existente

2. **Configurar regla para rama `main` (o `master`):**
   - **Branch name pattern:** `main`
   - ‚úÖ **Require status checks to pass before merging**
   - ‚úÖ **Require branches to be up to date before merging**
   - **Status checks required:**
     - ‚úÖ `SonarQube Quality Gate`
     - ‚úÖ `SonarQube Analysis`
     - ‚úÖ `Build Android Project`
     - ‚úÖ `Run Tests and Generate Coverage`
   - ‚úÖ **Require pull request reviews before merging**
   - ‚úÖ **Dismiss stale pull request approvals when new commits are pushed**
   - ‚úÖ **Do not allow bypassing the above settings**

3. **Guardar la regla**

## üì± PASO 3: Configurar Proyecto Android

### 3.1 Agregar Configuraci√≥n SonarQube

1. **Crear archivo `sonar-project.properties` en la ra√≠z del proyecto:**
   ```properties
   # Informaci√≥n del proyecto
   sonar.projectKey=tu_proyecto_android
   sonar.projectName=Tu Proyecto Android
   sonar.projectVersion=1.0
   
   # Configuraci√≥n de c√≥digo fuente
   sonar.sources=app/src/main/java,app/src/main/kotlin
   sonar.tests=app/src/test/java,app/src/test/kotlin
   
   # Configuraci√≥n de cobertura JaCoCo
   sonar.coverage.jacoco.xmlReportPaths=app/build/reports/jacoco/testDebugUnitTestCoverage/testDebugUnitTestCoverage.xml
   
   # Configuraci√≥n Android Lint
   sonar.android.lint.report=app/build/reports/lint-results-debug.xml
   
   # Binarios Java/Kotlin
   sonar.java.binaries=app/build/intermediates/javac,app/build/tmp/kotlin-classes
   sonar.java.libraries=app/build/intermediates/compile_and_runtime_not_namespaced_r_class_jar
   
   # Configuraci√≥n de idioma
   sonar.language=kotlin
   sonar.sourceEncoding=UTF-8
   
   # Exclusiones de archivos generados
   sonar.coverage.exclusions=**/R.java,**/R$*.java,**/BuildConfig.*,**/Manifest*.*,**/*Test*.*,**/databinding/**,**/generated/**
   ```

### 3.2 Configurar Gradle para JaCoCo

1. **Editar `app/build.gradle`:**
   ```gradle
   android {
       // ... configuraci√≥n existente
       
       testOptions {
           unitTests.all {
               useJUnitPlatform()
               finalizedBy jacocoTestReport
           }
       }
   }
   
   // Agregar plugin JaCoCo
   apply plugin: 'jacoco'
   
   // Configurar tarea JaCoCo
   task jacocoTestReport(type: JacocoReport, dependsOn: ['testDebugUnitTest']) {
       reports {
           xml.enabled = true
           html.enabled = true
           xml.destination file("${buildDir}/reports/jacoco/testDebugUnitTestCoverage/testDebugUnitTestCoverage.xml")
       }
       
       def fileFilter = [
           '**/R.class', '**/R$*.class', '**/BuildConfig.*', '**/Manifest*.*',
           '**/*Test*.*', 'android/**/*.*', '**/databinding/**', '**/generated/**'
       ]
       
       def debugTree = fileTree(dir: "${buildDir}/intermediates/javac/debug", excludes: fileFilter)
       def kotlinDebugTree = fileTree(dir: "${buildDir}/tmp/kotlin-classes/debug", excludes: fileFilter)
       
       classDirectories.from = files([debugTree, kotlinDebugTree])
       sourceDirectories.from = files(['src/main/java', 'src/main/kotlin'])
       executionData.from = fileTree(dir: "$buildDir", includes: ['**/*.exec', '**/*.ec'])
   }
   
   // Asegurar que JaCoCo se ejecute despu√©s de las pruebas
   tasks.withType(Test) {
       finalizedBy jacocoTestReport
   }
   ```

### 3.3 Copiar Workflow de GitHub Actions

1. **Crear directorio `.github/workflows/` si no existe**

2. **Copiar el archivo del workflow:**
   ```bash
   cp .github/workflows/sonar-analysis.yml tu-proyecto/.github/workflows/
   ```

   O crear manualmente el archivo `.github/workflows/sonar-analysis.yml` con el contenido del workflow.

## üß™ PASO 4: Probar el Sistema

### 4.1 Crear Pull Request de Prueba

1. **Crear una nueva rama:**
   ```bash
   git checkout -b test-sonarqube-integration
   ```

2. **Hacer un cambio menor en el c√≥digo**

3. **Commit y push:**
   ```bash
   git add .
   git commit -m "Test: SonarQube integration"
   git push origin test-sonarqube-integration
   ```

4. **Crear Pull Request en GitHub**

### 4.2 Verificar que el Pipeline se Ejecuta

1. **Ir a la pesta√±a "Actions" en GitHub**
2. **Verificar que se ejecuta el workflow "Android CI/CD with SonarQube"**
3. **Observar los jobs:**
   - ‚úÖ Build Android Project
   - ‚úÖ Run Tests and Generate Coverage
   - ‚úÖ SonarQube Analysis
   - ‚úÖ Quality Gate Validation

### 4.3 Verificar Bloqueo de Merge

1. **Si el c√≥digo tiene buena calidad (>80% cobertura, sin bugs cr√≠ticos):**
   - ‚úÖ Status checks aparecen en verde
   - ‚úÖ Bot√≥n "Merge" est√° habilitado

2. **Si el c√≥digo no cumple est√°ndares:**
   - ‚ùå Status checks aparecen en rojo
   - ‚ùå Bot√≥n "Merge" est√° deshabilitado
   - ‚ùå Mensaje: "Merge blocked by failing required status checks"

## üîç PASO 5: Verificar Configuraci√≥n

### 5.1 Verificar SonarQube

1. **Acceder a SonarQube:** `http://localhost:9000`
2. **Verificar que aparece tu proyecto**
3. **Verificar Quality Gate "Android Strict" como default**
4. **Revisar m√©tricas del proyecto**

### 5.2 Verificar GitHub Actions

1. **Ir a repositorio ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions**
2. **Verificar que existen:**
   - ‚úÖ `SONAR_HOST_URL`
   - ‚úÖ `SONAR_TOKEN`

### 5.3 Verificar Branch Protection

1. **Ir a repositorio ‚Üí Settings ‚Üí Branches**
2. **Verificar regla para rama principal**
3. **Verificar status checks requeridos**

### 5.4 Ejecutar Script de Validaci√≥n

```bash
# Ejecutar script de validaci√≥n completa
chmod +x scripts/test-deployment.sh
./scripts/test-deployment.sh

# Verificar configuraci√≥n GitHub
./scripts/setup-github-protection.sh --status
```

## üö® Troubleshooting

### Problema: SonarQube no accesible

**Soluci√≥n:**
```bash
# Verificar que el contenedor est√© ejecut√°ndose
docker ps | grep sonarqube

# Si no est√° ejecut√°ndose, iniciarlo
docker start $(docker ps -a | grep sonarqube | awk '{print $1}')

# Verificar acceso
curl -I http://localhost:9000
```

### Problema: GitHub Actions falla

**Verificar:**
1. ‚úÖ Secrets configurados correctamente
2. ‚úÖ Archivo `sonar-project.properties` existe
3. ‚úÖ Configuraci√≥n JaCoCo en `build.gradle`
4. ‚úÖ SonarQube accesible desde GitHub Actions

### Problema: Quality Gate no bloquea

**Verificar:**
1. ‚úÖ Branch Protection Rules configuradas
2. ‚úÖ Status checks requeridos incluyen "SonarQube Quality Gate"
3. ‚úÖ Quality Gate "Android Strict" es el default en SonarQube

### Problema: Cobertura baja

**Soluci√≥n:**
1. Agregar m√°s pruebas unitarias
2. Verificar exclusiones en `sonar-project.properties`
3. Verificar configuraci√≥n JaCoCo

## üìä M√©tricas del Quality Gate

El sistema bloquea merges si:

- ‚ùå **Cobertura < 80%**
- ‚ùå **Bugs cr√≠ticos > 0**
- ‚ùå **Vulnerabilidades altas > 0**
- ‚ùå **Code Smells blocker > 0**
- ‚ùå **L√≠neas duplicadas > 3%**
- ‚ùå **Ratings de calidad < A**

## üéâ ¬°Sistema Configurado!

Una vez completados todos los pasos:

‚úÖ **SonarQube analiza autom√°ticamente cada commit**
‚úÖ **GitHub bloquea merges que no cumplan est√°ndares**
‚úÖ **Solo c√≥digo de alta calidad llega a producci√≥n**
‚úÖ **Desarrolladores reciben feedback inmediato**

## üìû Soporte

Si tienes problemas:

1. **Revisar logs de GitHub Actions**
2. **Verificar logs de SonarQube**
3. **Ejecutar scripts de validaci√≥n**
4. **Consultar la documentaci√≥n en README.md**

---

**üîí Sistema que garantiza calidad de c√≥digo mediante bloqueo autom√°tico de merges hasta que el c√≥digo cumpla con los est√°ndares de SonarQube.**